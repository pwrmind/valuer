<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SLM Value Classifier 2026</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 20px auto; background: #f4f4f9; color: #333; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        textarea { width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 8px; padding: 12px; font-size: 16px; box-sizing: border-box; resize: vertical; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { font-size: 14px; margin-top: 10px; color: #666; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 25px; }
        .res-card { background: #f8f9fa; padding: 10px; border-radius: 6px; border-left: 4px solid #007bff; }
        .bar-bg { background: #e9ecef; height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .bar-fill { background: #28a745; height: 100%; transition: width 0.4s ease-out; }
    </style>
</head>
<body>

<div class="container">
    <h2>Анализ фундаментальных ценностей</h2>
    <div id="status">Инициализация WebGPU...</div>
    <textarea id="input" placeholder="Введите описание задачи, например: Прогулка с семьей в парке..."></textarea>
    <br>
    <button id="run" disabled>Проанализировать на GPU</button>

    <div id="results" class="results-grid"></div>
</div>

<script type="module">
    // Импорт Transformers.js v3 с поддержкой WebGPU
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

    // Настройка путей
    env.allowLocalModels = true;
    env.allowRemoteModels = false;

    const LABELS = ["Семья", "Работа", "Здоровье", "Саморазвитие", "Отдых", "Хобби", "Друзья", "Финансы", "Долг", "Свобода", "Справедливость", "Безопасность", "Экология", "Творчество", "Власть"];

    let classifier;

    async function init() {
        try {
            //env.local_files_only=true
            //env.allowLocalModels = false;
            env.allowRemoteModels = false;
            env.localModelPath = '/models';
            window.local_files_only=true

            // Загрузка модели из папки ./model/
            classifier = await pipeline('text-classification', '/', {
                model_file_name: 'model_quantized',
                device: 'webgpu',
                dtype: 'fp32', 
            });
            document.getElementById('status').textContent = 'Модель загружена в WebGPU VRAM. Готов к работе.';
            document.getElementById('run').disabled = false;
        } catch (e) {
            document.getElementById('status').textContent = 'Ошибка WebGPU: ' + e.message;
            console.error(e);
        }
    }

    async function run() {
        const text = document.getElementById('input').value;
        if (!text) return;

        document.getElementById('run').disabled = true;
        const start = performance.now();

        // Инференс
        const output = await classifier(text, {
            top_k: 15,
            function_to_apply: 'sigmoid'
        });
        
        const end = performance.now();
        document.getElementById('status').textContent = `Инференс завершен за ${(end - start).toFixed(2)} мс`;
        
        render(output);
        document.getElementById('run').disabled = false;
    }

    function render(data) {
        const container = document.getElementById('results');
        container.innerHTML = '';
        
        // Мапим результаты на наши названия ценностей
        const results = data.map((item, i) => ({
            name: LABELS[i] || item.label,
            score: item.score
        })).sort((a, b) => b.score - a.score);

        results.forEach(res => {
            const pct = Math.round(res.score * 100);
            if (pct < 5) return; // Скрываем незначимые

            const card = document.createElement('div');
            card.className = 'res-card';
            card.innerHTML = `
                <strong>${res.name}</strong>: ${pct}%
                <div class="bar-bg"><div class="bar-fill" style="width: ${pct}%"></div></div>
            `;
            container.appendChild(card);
        });
    }

    document.getElementById('run').onclick = run;
    init();
</script>

</body>
</html>
